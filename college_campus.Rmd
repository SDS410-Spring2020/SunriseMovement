---
title: "College Campuses"
author: "Emma Livingston"
date: "4/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(broom)
```

```{r}
college_campuses <- read_csv(here("/data/Smith_Capstone_College_Campus.csv"))
unique_matched <- read_csv(here("/data/Smith_Capstone_Voters_Unique.csv"))
college_demographics <- read_csv(here("/data/college_demographics.csv"))
additional_vars <- read_csv(here("/data/Smith_Capstone_Additional_Voter_File_Vars.csv"))
```

```{r}
codes_to_keep <- c("St Josephs", "Thomas Jefferson Uni", "Saint Anselm College", "Communty College Phl", "UniOfNorthernIowa", "Grand View Universit", "Dartmouth College", "Drake University", "Keene State College", "Simpson College", "Antioch University", "Great Bay CommColleg", "Manchester CommColle", "Plymouth State Unive", "New England College", "NHTI","OLDCommunty College", "White Mountains ComC", "Franklin Pierce Univ", "Granite State Colleg", "University of Iowa", "Grinnell University", "OLD Grinnel", "UniofNHampshireManch", "Temple", "River Valley CommCol", "Drexel University", "Southern New Hampshi", "Uni of New Hampshire", "Uni of Pennsylvania", "Iowa StateUniversity", "Central College", "Colby-Sawyer College", "UniScienceinPhilly", "La Salle", "DesMoinesCommCollege", "Rivier University")
```

```{r}
matched_w_campuses <- unique_matched %>%
  select(-contains("activistcode")) %>%
  left_join(select(college_campuses, vanid, activistcodeid, activistcodename), by = "vanid") %>%
  filter(activistcodename %in% codes_to_keep) 
full_data <- matched_w_campuses %>%
  left_join(select(additional_vars, van_id, vb_voterbase_race:tb_income_range_prem_cd), by = c("vanid" = "van_id"))
```



```{r}
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Caucasian" = "White_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Uncoded" = "Unknown_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Other" = "POC_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "African-American" = "POC_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Asian" = "POC_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Hispanic" = "POC_Count")
full_data$vb_voterbase_race <- recode(full_data$vb_voterbase_race, "Native American" = "POC_Count")

clean_data <- full_data %>% 
  select(van_id, activistcodeid, activistcodename, vb_voterbase_race)%>%
  filter(activistcodename %in% codes_to_keep)%>%
  mutate(vb_voterbase_race = replace_na(vb_voterbase_race, "Unknown_Count"))

counts <- clean_data %>%
  group_by(activistcodename, vb_voterbase_race)%>%
  count(vb_voterbase_race)%>%
  spread(vb_voterbase_race, n)
```

```{r}
# Expected proportions for each college
clean_college_dems <- college_demographics %>%
  select(activistcodename, nonresident_alien,	unknown_race,	two_or_more_races,	white,	native_hawaiian_or_other_pac_islander,	hispanic,	black_or_african_american,	asian,	american_indian_or_alaska_native)%>%
  mutate(unknown = nonresident_alien + unknown_race + two_or_more_races) %>% 
  mutate(POC = native_hawaiian_or_other_pac_islander + hispanic + black_or_african_american + asian + american_indian_or_alaska_native)%>%
  select(activistcodename, white, unknown, POC)
```

```{r}
counts_and_expected <- counts %>%
  inner_join(clean_college_dems, by = "activistcodename")%>%
  mutate(POC_Count = replace_na(POC_Count, 0))%>%
  mutate(Unknown_Count = replace_na(Unknown_Count, 0))%>%
  mutate(Prop_POC_Expected = (POC/100))%>%
  mutate(Prop_White_Expected = (white/100))%>%
  mutate(Prop_Unknown_Expected = (unknown/100))%>%
  select(activistcodename, POC_Count, White_Count, Unknown_Count, Prop_POC_Expected, Prop_White_Expected, Prop_Unknown_Expected)%>%
  mutate(sum_prop = (Prop_POC_Expected + Prop_White_Expected + Prop_Unknown_Expected)) #%>% #fix this
  #filter(sum_prop == 1) #fix this
View(counts_and_expected)
```

```{r}
# for (i in counts_and_expected) {
#   counts <- c(counts_and_expected$POC_Count, counts_and_expected$White_Count, counts_and_expected$Unknown_Count)
#   p <- c(counts_and_expected$Prop_POC_Expected, counts_and_expected$Prop_White_Expected, counts_and_expected$Prop_Unknown_Expected)
# res <- chisq.test(counts, p)
# print(res)
# }
#problem because some expected values are too low
```

```{r}
#need a dataset with state and college_type
test_data <- counts_and_expected %>%
  inner_join(college_demographics, by = "activistcodename") %>%
  #Need actual proportions for visualizations
  mutate(Prop_POC_Actual = POC_Count / (POC_Count+White_Count+Unknown_Count),
         Prop_White_Actual = White_Count / (POC_Count+White_Count+Unknown_Count),
         Prop_Unknown_Actual = Unknown_Count / (POC_Count+White_Count+Unknown_Count))
  
#see how many of each college type each state has
test_data %>%
  group_by(state, college_type) %>%
  count()

#find total counts of campaigned people in each college
test_data <- test_data %>%
  mutate(total_count = POC_Count + White_Count + Unknown_Count,
  expected_POC_count = total_count * Prop_POC_Expected,
  expected_White_count = total_count * Prop_White_Expected,
  expected_Unknown_count = total_count * Prop_Unknown_Expected)

#Find which colleges have expected count < 5
colleges_to_group <- test_data %>%
  filter(expected_POC_count < 5 | expected_White_count < 5 | expected_Unknown_count < 5)
```

```{r}
#turn off scientific notation
options(scipen = 999)

#test chi_squared
results <- test_data %>%
  do(tidy(chisq.test(
    c(.$POC_Count, .$White_Count, .$Unknown_Count),
    p = c(
      .$Prop_POC_Expected,
      .$Prop_White_Expected,
      .$Prop_Unknown_Expected
    )
  )))
View(results)

#just basic college info to join with
college_info <- test_data %>%
  select(activistcodename, state, college_type)

#View all chi squared tests
results <- results %>%
  inner_join(college_info, by = "activistcodename") %>%
  select(-c(parameter, method))
View(results)
```


```{r}
#tidy
for_viz <- test_data %>%
  select(
    activistcodename,
    college_type,
    state,
    Prop_POC_Expected,
    Prop_White_Expected,
    Prop_Unknown_Expected,
    Prop_POC_Actual,
    Prop_White_Actual,
    Prop_Unknown_Actual
  ) %>%
  pivot_longer(
    c(
      Prop_POC_Expected,
      Prop_White_Expected,
      Prop_Unknown_Expected,
      Prop_POC_Actual,
      Prop_White_Actual,
      Prop_Unknown_Actual
    ),
    names_to = "case",
    values_to = "proportion"
  ) %>%
  separate(case, into = c("prop", "race", "value"), sep = "_") %>%
  select(-c(prop))

#plot
ggplot(for_viz, 
       aes(x = race, 
           y = proportion, 
           fill = value)) + 
  geom_bar(stat = "identity", 
           position = "dodge")  +
  facet_wrap(~college_type)

#BY STATE:
ggplot(for_viz, 
       aes(x = race, 
           y = proportion, 
           fill = value)) + 
  geom_bar(stat = "identity", 
           position = "dodge") + 
  facet_wrap(state~college_type)

#Just NH
ggplot(filter(for_viz, state == "NH"),
       aes(x = race, y = proportion, fill = value)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ college_type) +
  ggtitle("New Hampshire")

#Just IA
ggplot(filter(for_viz, state == "IA"),
       aes(x = race, y = proportion, fill = value)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ college_type) +
  ggtitle("Iowa")

#Just PA
ggplot(filter(for_viz, state == "PA"),
       aes(x = race, y = proportion, fill = value)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ college_type) +
  ggtitle("Pennsylvania")

#Without colleges with too small of expected counts
for_viz_2 <- for_viz %>%
  anti_join(colleges_to_group, by = "activistcodename")

#BY STATE:
ggplot(for_viz_2, 
       aes(x = race, 
           y = proportion, 
           fill = value)) + 
  geom_bar(stat = "identity", 
           position = "dodge") + 
  facet_wrap(state~college_type)

#see how many of each type of college per state is left after removed the ones not possible
#to run a chi-squared test on
# for_viz_2 %>%
#   group_by(state, college_type) %>%
#   count()
```

```{r}
#combine NH community colleges that we couldn't run individual tests on
#THIS DOESNT WORK: even combining them gives expected count of < 5 
NH_test_data <- test_data %>%
  filter(activistcodename %in% c("Great Bay CommColleg", "Manchester CommColle", "NHTI")) %>%
  mutate(NH_POC_Count = mean(NH_test_data$POC_Count),
         NH_White_Count = mean(NH_test_data$White_Count),
         NH_Unknown_Count = mean(NH_test_data$Unknown_Count),
         NH_Expected_POC_Count = mean(NH_test_data$expected_POC_count),
         NH_Expected_White_Count = mean(NH_test_data$expected_White_count),
         NH_Expected_Unknown_Count = mean(NH_test_data$expected_Unknown_count),
         NH_Prop_POC_Expected = mean(NH_test_data$Prop_POC_Expected),
         NH_Prop_White_Expected = mean(NH_test_data$Prop_White_Expected),
         NH_Prop_Unknown_Expected = mean(NH_test_data$Prop_Unknown_Expected),
         NH_Prop_POC_Actual = mean(NH_test_data$Prop_POC_Actual),
         NH_Prop_White_Actual = mean(NH_test_data$Prop_White_Actual),
         NH_Prop_Unknown_Actual = mean(NH_test_data$Prop_Unknown_Actual))

NH_test_data[1, 1] <- "combined_NH_2yr_coll"

NH_test_data <- NH_test_data %>%
  filter(activistcodename == "combined_NH_2yr_coll") %>%
  select(contains("NH")) %>%
  View()

```

```{r}
#trying another way by summing
NH_test_data <- test_data %>%
  filter(activistcodename %in% c("Great Bay CommColleg", "Manchester CommColle", "NHTI"))%>%
  mutate(NH_POC_Count = sum(NH_test_data$POC_Count),
         NH_White_Count = sum(NH_test_data$White_Count),
         NH_Unknown_Count = sum(NH_test_data$Unknown_Count),
         NH_Expected_POC_Count = sum(NH_test_data$expected_POC_count),
         NH_Expected_White_Count = sum(NH_test_data$expected_White_count),
         NH_Expected_Unknown_Count = sum(NH_test_data$expected_Unknown_count),
         #summing proportiongs doesn't make sense
         NH_Prop_POC_Expected = sum(NH_test_data$Prop_POC_Expected),
         NH_Prop_White_Expected = sum(NH_test_data$Prop_White_Expected),
         NH_Prop_Unknown_Expected = sum(NH_test_data$Prop_Unknown_Expected),
         NH_Prop_POC_Actual = sum(NH_test_data$Prop_POC_Actual),
         NH_Prop_White_Actual = sum(NH_test_data$Prop_White_Actual),
         NH_Prop_Unknown_Actual = sum(NH_test_data$Prop_Unknown_Actual))

NH_test_data[1, 1] <- "combined_NH_2yr_coll"

NH_test_data <- NH_test_data %>%
  filter(activistcodename == "combined_NH_2yr_coll") %>%
  select(contains("NH"))

results_NH <- NH_test_data %>%
  do(tidy(chisq.test(
    c(.$POC_Count, .$White_Count, .$Unknown_Count),
    p = c(
      .$Prop_POC_Expected,
      .$Prop_White_Expected,
      .$Prop_Unknown_Expected
    )
  )))
View(results)
```


